---
import { Icon } from "astro-icon/components";
---

<template id="x-icons">
  <Icon
    name="lucide:sun"
    id="x-light"
    role="presentation"
    class="rotate-90 transition-transform duration-200"
  />
  <Icon
    name="lucide:moon-star"
    id="x-dark"
    role="presentation"
    class="rotate-90 transition-transform duration-200"
  />
  <Icon
    name="lucide:zap"
    id="x-auto"
    role="presentation"
    class="rotate-90 transition-transform duration-200"
  />
</template>

{/* This is intentionally inlined to avoid FOUC. */}
<script is:inline>
  if (!window.ThemeProvider)
    window.ThemeProvider = (function () {
      const storedTheme =
        typeof localStorage !== "undefined" && localStorage.getItem("x-theme");
      const mql = window.matchMedia("(prefers-color-scheme: light)");
      const theme = storedTheme || (mql.matches ? "light" : "dark");
      document.documentElement.dataset.mode = theme;
      document.documentElement.dataset.theme = `github-${theme}-default`;
      return {
        updatePicker(theme = storedTheme || "auto") {
          const picker = document.querySelector("theme-picker");
          /** @type {HTMLTemplateElement | null} */
          const tmpl = document.getElementById("x-icons");
          const themeIcon = tmpl?.content?.getElementById(`x-${theme}`);
          picker?.querySelector("svg")?.remove();
          themeIcon &&
            picker
              ?.querySelector("span")
              ?.insertAdjacentElement("afterend", themeIcon.cloneNode(true));
        },
      };
    })();
</script>
