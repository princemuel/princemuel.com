<theme-picker class="contents">
  <button
    type="button"
    title="Toggle Theme"
    class="relative bg-zinc-600 text-2xl text-white transition-transform delay-200 duration-200 ease-in"
  >
    <span class="sr-only">Toggle theme</span>
  </button>
</theme-picker>

{/* Inlined to avoid FOUC. Uses global scope from `theme-provider.astro` */}
<script is:inline>
  window.ThemeProvider.updatePicker();
</script>

<script>
  import { create_custom_el } from "@/helpers/custom-elements";
  import { getElement } from "@/helpers/dom";

  type Theme = (typeof themes)[number];

  const storageKey = "x-theme";
  const mql = matchMedia("(prefers-color-scheme: light)");
  const themes = ["auto", "dark", "light"] as const;

  /** Yield the next theme, looping back to the first after reaching the end. */
  const themeGenerator = (function* () {
    let index = 0;
    while (true) {
      yield themes[index];
      index = (index + 1) % themes.length;
    }
  })();

  const getPreferredColorScheme = (): Theme => (mql.matches ? "light" : "dark");

  const parseTheme = (theme: unknown): Theme =>
    theme === "auto" || theme === "dark" || theme === "light" ? theme : "auto";
  const loadTheme = (): Theme =>
    parseTheme(typeof localStorage !== "undefined" && localStorage.getItem(storageKey));

  function storeTheme(theme: Theme) {
    if (typeof localStorage !== "undefined") {
      localStorage.setItem(
        storageKey,
        theme === "light" || theme === "dark" ? theme : "",
      );
    }
  }

  /** Update theme widget, document theme, and local storage state. */
  function onThemeChange(theme: Theme) {
    window.ThemeProvider.updatePicker(theme);
    document.documentElement.dataset.mode =
      theme === "auto" ? getPreferredColorScheme() : theme;
    document.documentElement.dataset.theme =
      theme === "auto"
        ? `github-${getPreferredColorScheme()}-default`
        : `github-${theme}-default`;
    storeTheme(theme);
  }

  // React to changes in system color scheme.
  mql.addEventListener("change", () => {
    if (loadTheme() === "auto") onThemeChange("auto");
  });

  class AstroThemePicker extends HTMLElement {
    btn: HTMLButtonElement;
    handleClick: (e: MouseEvent) => void;
    constructor() {
      super();
      this.btn = getElement("button", HTMLButtonElement, this);
      this.handleClick = this.#handleThemeChange.bind(this);
    }

    connectedCallback() {
      console.log("Init Theme Picker");
      onThemeChange(loadTheme());
      this.btn.addEventListener("click", this.handleClick);
    }

    #handleThemeChange(e: MouseEvent) {
      if (e.currentTarget instanceof HTMLButtonElement) {
        onThemeChange(parseTheme(themeGenerator.next().value));
      }
    }

    disconnectedCallback() {
      console.log("Unmount Theme Picker");
      this.btn.removeEventListener("click", this.handleClick);
    }
  }
  create_custom_el("theme-picker", AstroThemePicker);
</script>
